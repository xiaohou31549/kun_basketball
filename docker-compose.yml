version: '3'

services:
  nba-downloader:
    image: monkeyhurry/kun_basketball:latest  # 简化镜像地址
    container_name: nba-downloader
    volumes:
      - /volume1/video/NBA:/downloads  # 群晖的下载目录
    environment:
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      - CHROME_BIN=/usr/bin/chromium-browser
      - CHROMEDRIVER_PATH=/usr/bin/chromedriver
      - DEBUG=false  # 生产环境设置
    user: "1000:100"  # 使用普通用户权限
    restart: unless-stopped  # 自动重启
    command: |
      bash -c '
      echo "Starting immediate download task..." && \
      cd /app && python -m nba_downloader.nba_video_downloader >> /downloads/nba_downloader.log 2>&1 && \
      echo "Immediate download task completed. Setting up cron job..." && \
      echo "0 1 * * * cd /app && python -m nba_downloader.nba_video_downloader >> /downloads/nba_downloader.log 2>&1" > /etc/cron.d/nba-downloader && \
      chmod 0644 /etc/cron.d/nba-downloader && \
      crontab /etc/cron.d/nba-downloader && \
      echo "Cron job set up. Starting cron daemon..." && \
      cron -f'
